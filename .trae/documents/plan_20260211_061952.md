# Project Analysis and Optimization Plan

## 1. Analysis of Current State
- **Core Functionality**: The current implementation in `server/services/netease.ts` uses a simple regex `/(?:id=|\/song\/)(\d+)/`. This is fragile and fails for mixed text, short links, or complex URL parameters.
- **Frontend**: `LinkInput.tsx` strictly enforces `startsWith('http')`, preventing users from pasting copied share text (e.g., "Listen to this song... http://...").
- **UI/UX**: The interface is clean (React + Tailwind) but lacks feedback for complex parsing states (e.g., "Resolving link..."). Branding is generic ("NeteaseDL"), complying with the "no trae solo" requirement.

## 2. Optimization Strategy

### A. Robust Link Parsing Engine (Backend)
I will rewrite the `NeteaseProvider` class in `server/services/netease.ts` to include a multi-stage parsing pipeline:
1.  **Text Cleaning**: Extract the first valid HTTP/HTTPS URL from arbitrary input text.
2.  **Short Link Resolution**: Detect domains like `163.cn`, `y.music.163.com` and follow redirects to get the canonical URL using a `HEAD` request.
3.  **Advanced Regex Matching**: Use a more comprehensive set of regex patterns to capture IDs from various URL formats (params, paths, mobile web views).

### B. Smart Input Handling (Frontend)
Update `src/components/LinkInput.tsx`:
1.  Remove the strict `startsWith('http')` check.
2.  Allow pasting full share text.
3.  Add a "cleaning" step that visually highlights the extracted URL or sends the raw text to the backend for processing.

### C. UI/UX Refinements
1.  Enhance `LinkInput` to show processing states (e.g., "Analyzing link...").
2.  Ensure the design remains modern and strictly adheres to the "no branding" rule.

## 3. Implementation Steps

### Step 1: Backend Optimization (`server/services/netease.ts`)
- Implement `extractUrlFromText(text: string)`: Uses regex to find URLs in mixed content.
- Implement `resolveShortUrl(url: string)`: Follows HTTP redirects.
- Update `extractId(url: string)`: Supports standard, mobile, and redirect URLs.

### Step 2: Frontend Update (`src/components/LinkInput.tsx`)
- Relax validation logic.
- Improve error messages to be more specific (e.g., "No valid NetEase link found").

### Step 3: Verification & Testing
- Create a test script to verify:
    - Standard Links (`music.163.com/song?id=...`)
    - Short Links (`163.cn/...`)
    - Mixed Text (`Share text... http://...`)
- Verify the fix by attempting to parse these formats.

## 4. Deliverables
- Optimized `netease.ts` with robust parsing.
- Updated `LinkInput.tsx` with better UX.
- A functional verification report.
